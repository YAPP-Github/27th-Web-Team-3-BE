# Phase 4: PR 생성 및 리뷰 요청

## 1. 목표 및 범위

### 목표
- AI 자동화 파이프라인에서 생성된 코드 변경사항을 자동으로 PR로 생성
- 일관된 PR 형식과 품질 기준 유지
- 리뷰어에게 신속한 알림 제공
- CI/CD 파이프라인과의 원활한 연동

### 범위
- PR 생성 자동화 (제목, 본문, 라벨, 리뷰어)
- GitHub Actions CI/CD 연동
- Discord 알림 시스템
- 머지 조건 및 정책 정의

### 선행 조건
- Phase 1-3 완료 (코드 생성 및 검증 완료)
- 모든 테스트 통과 (`cargo test`)
- 코드 품질 검사 통과 (`cargo clippy`, `cargo fmt`)

---

## 2. PR 생성 자동화

### 2.1 PR 제목 템플릿

```
[AI-{타입}] {간결한 설명}
```

**타입 분류:**
| 타입 | 설명 | 예시 |
|------|------|------|
| `FEAT` | 새 기능 추가 | `[AI-FEAT] 회고 좋아요 토글 API 구현` |
| `FIX` | 버그 수정 | `[AI-FIX] 회고 삭제 시 500 에러 수정` |
| `REFACTOR` | 리팩토링 | `[AI-REFACTOR] AI 서비스 모듈 분리` |
| `DOCS` | 문서 변경 | `[AI-DOCS] API 명세서 업데이트` |
| `TEST` | 테스트 추가 | `[AI-TEST] 회고 CRUD 통합 테스트 추가` |

### 2.2 PR 본문 템플릿

```markdown
## Summary
<!-- AI가 자동 생성한 변경사항 요약 -->
- {주요 변경사항 1}
- {주요 변경사항 2}
- {주요 변경사항 3}

## Changes
<!-- 파일별 변경 내용 -->
### Added
- `{파일 경로}`: {설명}

### Modified
- `{파일 경로}`: {설명}

### Deleted
- `{파일 경로}`: {설명}

## Test Plan
<!-- 테스트 방법 및 결과 -->
- [ ] 단위 테스트 통과
- [ ] 통합 테스트 통과
- [ ] 수동 테스트 (필요시)

## Checklist
- [ ] `cargo fmt --check` 통과
- [ ] `cargo clippy -- -D warnings` 통과
- [ ] `cargo test` 통과
- [ ] API 문서 업데이트 (해당시)
- [ ] 리뷰 문서 작성 (`docs/reviews/`)

## Related Issues
<!-- 관련 이슈 링크 -->
- Closes #{이슈번호}

## AI Generation Info
- Generated by: Claude Code
- Phase: 4 (PR Creation)
- Timestamp: {ISO8601 타임스탬프}
```

### 2.3 변경사항 요약 자동 생성

**스크립트 예시 (`scripts/generate-pr-summary.sh`):**

```bash
#!/bin/bash

# 변경된 파일 목록 추출
ADDED_FILES=$(git diff --name-status origin/dev...HEAD | grep '^A' | awk '{print $2}')
MODIFIED_FILES=$(git diff --name-status origin/dev...HEAD | grep '^M' | awk '{print $2}')
DELETED_FILES=$(git diff --name-status origin/dev...HEAD | grep '^D' | awk '{print $2}')

# 커밋 메시지에서 요약 추출
COMMIT_MESSAGES=$(git log origin/dev..HEAD --pretty=format:"- %s")

# PR 본문 생성
cat << EOF
## Summary
${COMMIT_MESSAGES}

## Changes
### Added
$(echo "$ADDED_FILES" | while read f; do [ -n "$f" ] && echo "- \`$f\`"; done)

### Modified
$(echo "$MODIFIED_FILES" | while read f; do [ -n "$f" ] && echo "- \`$f\`"; done)

### Deleted
$(echo "$DELETED_FILES" | while read f; do [ -n "$f" ] && echo "- \`$f\`"; done)
EOF
```

### 2.4 라벨 자동 할당

**라벨 매핑:**
| 조건 | 라벨 |
|------|------|
| `codes/server/src/domain/` 변경 | `domain` |
| `codes/server/tests/` 변경 | `test` |
| `docs/` 변경 | `documentation` |
| `.github/` 변경 | `ci/cd` |
| AI 생성 PR | `ai-generated` |
| 긴급 수정 | `hotfix` |

**gh CLI 명령:**
```bash
gh pr create \
  --title "[AI-FEAT] 회고 좋아요 토글 API 구현" \
  --body-file pr-body.md \
  --label "ai-generated,domain,test" \
  --reviewer "team-lead,backend-reviewer"
```

### 2.5 리뷰어 자동 할당

**리뷰어 할당 규칙:**
| 변경 범위 | 리뷰어 |
|----------|--------|
| API 핸들러/DTO | 백엔드 리드 |
| 데이터베이스 변경 | DBA 또는 백엔드 시니어 |
| 인프라/CI/CD | DevOps 담당자 |
| AI 관련 로직 | AI 담당자 |

**CODEOWNERS 파일 예시 (`.github/CODEOWNERS`):**
```
# 전체 코드베이스
* @backend-team

# 도메인별 담당자
codes/server/src/domain/ai/ @ai-lead
codes/server/src/domain/retrospect/ @backend-lead
codes/server/src/domain/member/ @backend-lead

# 인프라
.github/ @devops-team
ci/ @devops-team

# 문서
docs/ @tech-writer @backend-lead
```

---

## 3. CI/CD 연동

### 3.1 GitHub Actions 트리거

현재 프로젝트의 CI/CD 설정 기반:

**`.github/workflows/deploy.yml` 트리거 조건:**
- `dev` 브랜치로 push 시 자동 빌드 및 배포
- `dev` 브랜치로 PR 시 빌드 및 테스트만 실행

**PR 생성 시 자동 실행되는 검증:**
```yaml
# PR 이벤트 트리거 (codes/** 변경 시)
on:
  pull_request:
    branches:
      - dev
    paths:
      - 'codes/**'
```

### 3.2 빌드 및 테스트 결과 확인

**검증 단계:**
1. **Checkout**: 코드 체크아웃
2. **Setup Rust**: Rust 툴체인 설정 (rustfmt, clippy 포함)
3. **Cache cargo**: 의존성 캐싱
4. **Check formatting**: `cargo fmt --check`
5. **Clippy**: `cargo clippy -- -D warnings`
6. **Build**: `cargo build --release`
7. **Test**: `cargo test`

**CI 실패 시 자동 조치:**
```yaml
# PR에 CI 실패 코멘트 추가
- name: Comment on PR (Failure)
  if: failure()
  uses: actions/github-script@v7
  with:
    script: |
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: '## CI Check Failed\n\nPlease review the failing checks and fix the issues.'
      })
```

### 3.3 PR 상태 체크 워크플로우

**추가 권장 워크플로우 (`.github/workflows/pr-check.yml`):**

```yaml
name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            refactor
            test
            chore

      - name: Check PR Size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 10
          s_label: 'size/S'
          s_max_size: 100
          m_label: 'size/M'
          m_max_size: 500
          l_label: 'size/L'
          l_max_size: 1000
          xl_label: 'size/XL'

      - name: AI Label Check
        if: startsWith(github.event.pull_request.title, '[AI-')
        run: |
          echo "AI-generated PR detected"
          gh pr edit ${{ github.event.pull_request.number }} --add-label "ai-generated"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 4. 리뷰 요청 알림

### 4.1 Discord 알림

**Discord Webhook 연동 워크플로우:**

```yaml
name: Discord Notification

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'ai-generated')
    steps:
      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "New AI-Generated PR"
          description: |
            **${{ github.event.pull_request.title }}**

            Author: ${{ github.event.pull_request.user.login }}
            Branch: `${{ github.event.pull_request.head.ref }}`

            [View PR](${{ github.event.pull_request.html_url }})
          color: 0x5865F2
          username: "GitHub Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
```

### 4.2 알림 메시지 템플릿

**Discord 메시지 형식:**
```
## New AI-Generated PR

**제목**: [AI-FEAT] 회고 좋아요 토글 API 구현
**브랜치**: feature/ai-like-toggle -> dev
**작성자**: claude-code-bot

### 변경 요약
- 좋아요 토글 API 엔드포인트 추가
- 좋아요 서비스 로직 구현
- 통합 테스트 추가

### CI 상태
- Build: Pending
- Test: Pending

[PR 링크](https://github.com/org/repo/pull/123)

@backend-team 리뷰 부탁드립니다.
```

### 4.3 담당자 멘션 규칙

| 상황 | 멘션 대상 |
|------|----------|
| 일반 PR | `@backend-team` |
| 긴급 수정 | `@backend-lead` `@on-call` |
| AI 관련 변경 | `@ai-team` |
| 인프라 변경 | `@devops-team` |
| 문서 변경 | `@tech-writer` |

---

## 5. 머지 조건 및 정책

### 5.1 필수 머지 조건

**Branch Protection Rules:**

| 조건 | 설정 |
|------|------|
| 최소 리뷰어 승인 수 | 1명 |
| 코드 오너 리뷰 필수 | 활성화 |
| 상태 체크 필수 | `build`, `test`, `clippy`, `fmt` |
| 브랜치 최신 상태 필수 | 활성화 |
| 관리자 포함 | 활성화 |

**GitHub 설정 예시:**
```json
{
  "required_status_checks": {
    "strict": true,
    "contexts": [
      "Build & Test",
      "Terraform"
    ]
  },
  "required_pull_request_reviews": {
    "required_approving_review_count": 1,
    "require_code_owner_reviews": true,
    "dismiss_stale_reviews": true
  },
  "restrictions": null,
  "enforce_admins": true
}
```

### 5.2 AI 생성 PR 특별 정책

**추가 검토 사항:**
- [ ] AI가 생성한 코드의 논리적 정확성 확인
- [ ] 보안 취약점 검토 (하드코딩된 비밀 등)
- [ ] 기존 코드와의 일관성 확인
- [ ] 불필요한 의존성 추가 여부 확인
- [ ] 테스트 커버리지 적절성 확인

**자동 머지 조건 (선택적):**
```yaml
# 조건을 모두 만족하면 자동 머지
- 모든 CI 체크 통과
- 1명 이상 승인
- 변경 파일 50개 미만
- 라벨에 'auto-merge' 포함
```

### 5.3 머지 전략

| 상황 | 전략 | 이유 |
|------|------|------|
| 기능 추가 | Squash and merge | 깔끔한 히스토리 |
| 핫픽스 | Merge commit | 추적 용이 |
| 대규모 변경 | Rebase and merge | 커밋별 추적 필요 |

---

## 6. 구현 체크리스트

### 6.1 필수 구현

- [ ] PR 생성 스크립트 작성 (`scripts/create-pr.sh`)
- [ ] PR 본문 템플릿 파일 생성 (`.github/PULL_REQUEST_TEMPLATE.md`)
- [ ] CODEOWNERS 파일 설정 (`.github/CODEOWNERS`)
- [ ] Discord Webhook 설정 및 시크릿 등록
- [ ] Branch Protection Rules 설정

### 6.2 선택적 구현

- [ ] 자동 머지 봇 설정 (Mergify 또는 GitHub Actions)
- [ ] PR 사이즈 라벨러 설정
- [ ] Semantic PR 타이틀 검증
- [ ] 리뷰 리마인더 봇 설정
- [ ] 머지 후 브랜치 자동 삭제 설정

### 6.3 설정 파일 체크리스트

```
.github/
├── CODEOWNERS                 # 코드 오너 정의
├── PULL_REQUEST_TEMPLATE.md   # PR 템플릿
├── workflows/
│   ├── deploy.yml            # 기존 빌드/배포
│   ├── terraform.yml         # 기존 테라폼
│   ├── pr-check.yml          # PR 검증 (신규)
│   └── discord-notify.yml    # Discord 알림 (신규)
└── dependabot.yml            # 의존성 업데이트 (선택)
```

---

## 7. 테스트 시나리오

### 7.1 PR 생성 테스트

| 시나리오 | 기대 결과 |
|----------|----------|
| 정상 PR 생성 | 제목, 본문, 라벨, 리뷰어 자동 설정 |
| AI 타입 PR | `ai-generated` 라벨 자동 추가 |
| 빈 변경사항 | PR 생성 실패 및 에러 메시지 |
| 충돌 발생 | PR 생성 후 충돌 표시 |

### 7.2 CI/CD 연동 테스트

| 시나리오 | 기대 결과 |
|----------|----------|
| PR 생성 시 | Build & Test 자동 실행 |
| 테스트 실패 시 | PR에 실패 코멘트 추가 |
| 모든 체크 통과 | 머지 버튼 활성화 |
| dev 머지 후 | 자동 배포 실행 |

### 7.3 알림 테스트

| 시나리오 | 기대 결과 |
|----------|----------|
| AI PR 생성 | Discord 알림 전송 |
| 리뷰 요청 | 리뷰어에게 멘션 알림 |
| CI 실패 | Discord에 실패 알림 |
| 머지 완료 | Discord에 완료 알림 |

### 7.4 End-to-End 테스트

```bash
# 1. 테스트 브랜치 생성
git checkout -b test/ai-pr-creation

# 2. 테스트 변경사항 추가
echo "// test" >> codes/server/src/main.rs

# 3. 커밋
git add .
git commit -m "test: AI PR creation test"

# 4. PR 생성
gh pr create \
  --title "[AI-TEST] PR 생성 자동화 테스트" \
  --body "테스트용 PR입니다." \
  --label "test,ai-generated"

# 5. 검증
# - CI 체크 실행 확인
# - Discord 알림 수신 확인
# - 리뷰어 할당 확인

# 6. 정리
gh pr close --delete-branch
```

---

## 8. 참고 자료

- [GitHub Actions 문서](https://docs.github.com/en/actions)
- [gh CLI 문서](https://cli.github.com/manual/)
- [Discord Webhooks 가이드](https://discord.com/developers/docs/resources/webhook)
- [Branch Protection Rules](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/defining-the-mergeability-of-pull-requests/about-protected-branches)

---

## 9. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-02-01 | Claude Code | 초안 작성 |
