# 시스템 아키텍처

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Production Environment                          │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Rust Backend Server                             │ │
│  │                                                                         │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────────┐ │ │
│  │  │   Handler   │───▶│   Service   │───▶│   External APIs (Claude)    │ │ │
│  │  └─────────────┘    └─────────────┘    └─────────────────────────────┘ │ │
│  │         │                  │                         │                  │ │
│  │         ▼                  ▼                         ▼                  │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                    Tracing Layer                                 │   │ │
│  │  │  - Structured JSON logs                                          │   │ │
│  │  │  - Request ID propagation                                        │   │ │
│  │  │  - Span context (handler → service → external)                   │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Log Output Layer                                │ │
│  │                                                                         │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────────┐ │ │
│  │  │   stdout    │    │  Log File   │    │   Log Forwarder (Vector)    │ │ │
│  │  │   (JSON)    │    │  (rotate)   │    │   (optional)                │ │ │
│  │  └─────────────┘    └─────────────┘    └─────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Log Aggregation Layer                             │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  Option A: File-based (MVP)                                             ││
│  │  - 로그 파일 직접 읽기                                                   ││
│  │  - tail -f 방식 또는 주기적 polling                                      ││
│  │  - 단순하고 빠른 구현                                                    ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  Option B: Loki (Production)                                            ││
│  │  - Grafana Loki로 중앙 집중 로그 저장                                    ││
│  │  - LogQL로 복잡한 쿼리 가능                                              ││
│  │  - 장기 보관 및 검색 최적화                                              ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │  Option C: CloudWatch (AWS)                                             ││
│  │  - AWS 네이티브 통합                                                     ││
│  │  - CloudWatch Logs Insights                                             ││
│  │  - Lambda 트리거 연동 가능                                               ││
│  └─────────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AI Processing Layer                               │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                     Log Watcher Agent                             │       │
│  │                                                                   │       │
│  │  Trigger Conditions:                                              │       │
│  │  ┌─────────────────────────────────────────────────────────────┐ │       │
│  │  │ 1. ERROR level 로그 감지                                     │ │       │
│  │  │ 2. 응답 시간 임계치 초과 (duration_ms > 5000)                │ │       │
│  │  │ 3. 에러율 급증 (5분 내 에러 > 10건)                          │ │       │
│  │  │ 4. 특정 에러 코드 패턴 (AI_*, AUTH_*, DB_*)                  │ │       │
│  │  └─────────────────────────────────────────────────────────────┘ │       │
│  │                              │                                    │       │
│  │                              ▼                                    │       │
│  │  Deduplication:                                                   │       │
│  │  ┌─────────────────────────────────────────────────────────────┐ │       │
│  │  │ - 동일 에러 5분 내 중복 무시                                 │ │       │
│  │  │ - 에러 fingerprint 기반 그룹핑                               │ │       │
│  │  │ - 발생 횟수 카운팅                                           │ │       │
│  │  └─────────────────────────────────────────────────────────────┘ │       │
│  └──────────────────────────────────────────────────────────────────┘       │
│                                       │                                      │
│                                       ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                    Diagnostic Agent (Claude)                      │       │
│  │                                                                   │       │
│  │  Input:                                                           │       │
│  │  ┌─────────────────────────────────────────────────────────────┐ │       │
│  │  │ - 에러 로그 전문                                             │ │       │
│  │  │ - Stack trace (있는 경우)                                    │ │       │
│  │  │ - 관련 소스 코드 (파일 경로 기반)                            │ │       │
│  │  │ - 최근 커밋 이력 (git log)                                   │ │       │
│  │  │ - 유사 에러 이력                                             │ │       │
│  │  └─────────────────────────────────────────────────────────────┘ │       │
│  │                              │                                    │       │
│  │                              ▼                                    │       │
│  │  Output:                                                          │       │
│  │  ┌─────────────────────────────────────────────────────────────┐ │       │
│  │  │ - 심각도 판정 (Critical / Warning / Info)                    │ │       │
│  │  │ - 근본 원인 분석 (Root Cause Analysis)                       │ │       │
│  │  │ - 영향 범위 평가                                             │ │       │
│  │  │ - 권장 조치 사항                                             │ │       │
│  │  │ - 자동 수정 가능 여부                                        │ │       │
│  │  └─────────────────────────────────────────────────────────────┘ │       │
│  └──────────────────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           ▼                           ▼                           ▼
┌─────────────────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│   Discord Alert     │     │   GitHub Issue      │     │   Auto-Fix Agent    │
│                     │     │                     │     │                     │
│ - 실시간 Webhook    │     │ - gh CLI 사용       │     │ - Claude Code       │
│ - 심각도별 멘션     │     │ - 라벨 자동 지정    │     │ - Draft PR 생성     │
│ - 스레드 그룹핑     │     │ - 중복 이슈 체크    │     │ - 테스트 실행       │
└─────────────────────┘     └─────────────────────┘     └─────────────────────┘
```

## 데이터 흐름

### 1. 로그 생성 (Rust Server)
```
HTTP Request
    │
    ▼
┌─────────────┐
│  Middleware │ ─── request_id 생성, 시작 시간 기록
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Handler   │ ─── info!(request_id, "Request received")
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Service   │ ─── debug!(request_id, "Processing...")
└──────┬──────┘     error!(request_id, error_code, "Failed")
       │
       ▼
┌─────────────┐
│  Response   │ ─── info!(request_id, status, duration_ms, "Response sent")
└─────────────┘
```

### 2. 로그 수집 및 분석
```
Log File / Stream
    │
    ├─── [5분 간격] ───▶ Log Watcher Agent
    │                         │
    │                         ├─── ERROR 감지? ───▶ Diagnostic Agent 호출
    │                         │
    │                         ├─── 패턴 매칭? ───▶ 집계 후 리포트
    │                         │
    │                         └─── 정상 ───▶ 무시
    │
    └─── [실시간] ───▶ (Future: Stream Processing)
```

### 3. 알림 및 대응
```
Diagnostic Agent 결과
    │
    ├─── Critical ───▶ Discord 즉시 알림 + GitHub Issue 생성
    │                       │
    │                       └─── 자동 수정 가능? ───▶ Auto-Fix PR
    │
    ├─── Warning ───▶ Discord 집계 알림 (1시간 단위)
    │
    └─── Info ───▶ 로그만 기록 (대시보드 반영)
```

## 컴포넌트 상세

### Log Watcher Agent
- **역할**: 로그 스트림 모니터링 및 이벤트 감지
- **실행 방식**:
  - MVP: Cron job (5분 간격)
  - Production: 상시 실행 프로세스
- **주요 기능**:
  - JSON 로그 파싱
  - 패턴 기반 필터링
  - 중복 제거 (fingerprint 기반)
  - Diagnostic Agent 트리거

### Diagnostic Agent
- **역할**: 에러 컨텍스트 분석 및 진단
- **사용 모델**: Claude API (환경변수 `DIAGNOSTIC_MODEL`, 기본값: `claude-sonnet-4-20250514`)
  - **기본값 선택 근거**: Sonnet은 코드 분석과 복잡한 맥락 이해에 적합. 비용 절감이 우선이면 `claude-haiku-3-5-20241022`로 변경 시 약 90% 비용 절감 가능 (정확도 다소 감소 가능)
- **입력 데이터**:
  - 에러 로그 (최근 100줄)
  - 관련 소스 코드
  - git blame / log 정보
- **출력 데이터**:
  - 구조화된 진단 보고서 (JSON)

### Alert Manager
- **역할**: 알림 발송 및 이슈 생성
- **Discord 연동**: Webhook API
- **GitHub 연동**: gh CLI
- **알림 정책**:
  - Critical: 즉시 + @here 멘션
  - Warning: 집계 후 발송
  - Info: 대시보드만

### Auto-Fix Agent
- **역할**: 자동 코드 수정 시도
- **사용 도구**: Claude Code CLI
- **제한 사항**:
  - Draft PR만 생성
  - 테스트 통과 필수
  - 보안 관련 코드 수정 불가
  - 아키텍처 변경 불가

## 배포 구성

### MVP (Phase 1)
```
┌─────────────────────────────────────┐
│          Same Server                │
│                                     │
│  ┌─────────────┐  ┌──────────────┐ │
│  │ Rust Server │  │ Monitor      │ │
│  │             │──│ Script       │ │
│  │ (logs/)     │  │ (cron)       │ │
│  └─────────────┘  └──────────────┘ │
└─────────────────────────────────────┘
```

### Production (Phase 2+)
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Rust Server    │    │  Loki           │    │  Monitor        │
│  (ECS/EC2)      │───▶│  (Centralized)  │◀───│  (Lambda/ECS)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```
